services:
  # 1. Database
  postgres:
    image: postgres:16-alpine
    container_name: nearnow_postgres
    restart: always
    environment:
      POSTGRES_USER: nearnow_admin
      POSTGRES_PASSWORD: production_password_change_me
      POSTGRES_DB: nearnow_db
    ports:
      - "5432:5432" # In prod, map only to localhost if possible, or use firewall
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data

  # 2. Redis
  redis:
    image: redis:7-alpine
    container_name: nearnow_redis
    restart: always
    volumes:
      - redis_data_prod:/data

  # 3. Backend API
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: nearnow_api
    restart: always
    environment:
      DATABASE_URL: postgresql://nearnow_admin:production_password_change_me@postgres:5432/nearnow_db?schema=public
      REDIS_URL: redis://redis:6379
      PORT: 3002
      # Add other ENV vars here (JWT_SECRET, etc)
    depends_on:
      - postgres
      - redis

  # 4. Frontend Web
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: nearnow_web
    restart: always
    environment:
      # In Docker, we talk to Nginx or directly to API internal URL
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3002}
      NEXT_PUBLIC_SOCKET_URL: ${NEXT_PUBLIC_API_URL:-http://localhost:3002}
      INTERNAL_API_URL: http://api:3002 # Server side sees this
    depends_on:
      - api

  # 5. Nginx (Reverse Proxy)
  nginx:
    image: nginx:alpine
    container_name: nearnow_nginx
    restart: always
    ports:
      - "80:80"
      #- "443:443" # Uncomment when adding SSL certs
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - web
      - api

volumes:
  postgres_data_prod:
  redis_data_prod:
